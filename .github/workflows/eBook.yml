name: Publish AsciiDoc as eBook Release

on:
  push:
    branches:
      - master

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'

    - name: Install Asciidoctor and Dependencies
      run: |
        gem install asciidoctor asciidoctor-pdf asciidoctor-epub3 rouge

    - name: Add Fonts
      run: |
        mkdir -p fonts
        wget https://noto-website-2.storage.googleapis.com/pkgs/NotoSansCJKsc-hinted.zip -O fonts/NotoSansCJKsc-hinted.zip
        unzip fonts/NotoSansCJKsc-hinted.zip -d fonts/

    - name: Create PDF Theme
      run: |
        cat > theme.yml <<EOL
        extends: default

        font:
          catalog:
            NotoSans:
              normal: fonts/NotoSansCJKsc-Regular.otf
              bold: fonts/NotoSansCJKsc-Bold.otf
              italic: fonts/NotoSansCJKsc-Regular.otf
              bold_italic: fonts/NotoSansCJKsc-Bold.otf

          fallbacks:
            - NotoSans

          default_family: NotoSans
        EOL

    - name: Convert AsciiDoc to PDF
      run: |
        mkdir -p output
        asciidoctor-pdf -D output book.asciidoc -a pdf-theme=theme.yml -a pdf-fontsdir=fonts

    - name: Convert AsciiDoc to EPUB
      run: |
        asciidoctor-epub3 -D output book.asciidoc -a epub-embed-fonts=fonts/NotoSansCJKsc-Regular.otf,fonts/NotoSansCJKsc-Bold.otf

    - name: Copy Additional Resources
      run: cp -r images output/

    - name: Create Release Artifacts
      run: |
        cd output
        zip mastering-bitcoin.zip *.pdf *.epub

    - name: Upload to GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          output/mastering-bitcoin.zip
          output/book.pdf
          output/book.epub
        token: ${{ secrets.GITHUB_TOKEN }}
        tag_name: v1.0.0
        name: "Mastering Bitcoin eBook Release"
        body: |
          This release includes the latest version of the Mastering Bitcoin eBook in PDF and EPUB formats with proper Chinese font support.
